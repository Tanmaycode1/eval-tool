{% extends "base.html" %}

{% block title %}Shram.ai - Prompt Chain{% endblock %}

{% block content %}
    <!-- Compact Header with Versions Dropdown, Info Button, and Action Buttons -->
    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; flex-wrap: wrap;">
        <div style="flex: 1; display: flex; align-items: center; gap: 1rem; min-width: 200px;">
            <label style="font-weight: 500; color: var(--text-primary); white-space: nowrap;">Version:</label>
            <select id="versions-dropdown" class="control-select" style="flex: 1; max-width: 300px;" onchange="onVersionSelected()">
                <option value="">Loading versions...</option>
            </select>
        </div>
        <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
            <button id="regenerate-chain-btn" class="control-btn primary" onclick="regenerateChain()" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem;">
                <span>Regenerate Chain</span>
            </button>
            <button id="rate-review-btn" class="control-btn" onclick="openRatingModal()" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem;">
                <span>‚≠ê Rate & Review</span>
            </button>
            <button id="add-compare-btn" class="control-btn primary" onclick="addChainToCompare()" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem;">
                <span>Add to Compare</span>
            </button>
            <button id="metadata-info-btn" class="control-btn" onclick="openMetadataModal()" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem;">
                <svg style="width: 1.2rem; height: 1.2rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>Trace Info</span>
            </button>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 2000; align-items: center; justify-content: center; cursor: zoom-out;" onclick="closeImageModal()">
        <div style="position: relative; max-width: 95vw; max-height: 95vh; padding: 1rem;">
            <button onclick="closeImageModal(); event.stopPropagation();" style="position: absolute; top: -2rem; right: 0; background: rgba(255, 255, 255, 0.1); border: none; color: white; cursor: pointer; padding: 0.5rem 1rem; font-size: 1.5rem; border-radius: 4px; backdrop-filter: blur(10px);">&times;</button>
            <img id="modal-image" src="" style="max-width: 100%; max-height: 90vh; object-fit: contain; border-radius: 8px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);" onclick="event.stopPropagation()">
        </div>
    </div>

    <!-- Metadata Modal -->
    <div id="metadata-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: var(--bg-primary); border-radius: 12px; padding: 2rem; max-width: 600px; max-height: 80vh; overflow-y: auto; margin: 2rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 class="section-title" style="margin: 0;">Trace Metadata</h3>
                <button onclick="closeMetadataModal()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0.5rem; font-size: 1.5rem; line-height: 1;">&times;</button>
            </div>
            <div class="metadata-grid" id="metadata-grid">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div id="rating-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: var(--bg-primary); border-radius: 12px; padding: 2rem; max-width: 700px; max-height: 85vh; overflow-y: auto; margin: 2rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 class="section-title" style="margin: 0;">‚≠ê Rate & Review Response (Optional)</h3>
                <button onclick="closeRatingModal()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0.5rem; font-size: 1.5rem; line-height: 1;">&times;</button>
            </div>
            <div id="rating-modal-content" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Select Response to Rate</label>
                    <select id="chain-step-selector" class="control-select" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary);" onchange="onChainStepSelected()">
                        <option value="">Select a response step...</option>
                    </select>
                </div>
                <div id="chain-step-rating-container" style="display: none;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Overall Rating (1-10)</label>
                        <input type="number" id="chain-overall-rating" min="1" max="10" placeholder="Optional" style="width: 100%; max-width: 200px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary);">
                    </div>
                    <div id="chain-parameter-ratings-container" style="margin-top: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Rate Individual Parameters</label>
                        <div id="chain-parameter-ratings-list" style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">Parameters will be extracted from selected response</p>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">Review/Comment</label>
                        <textarea id="chain-rating-review" placeholder="Add your review or comments about this response (optional)..." style="width: 100%; min-height: 120px; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); resize: vertical; font-family: inherit;"></textarea>
                    </div>
                    <div style="display: flex; gap: 0.5rem; font-size: 0.85rem; color: var(--text-secondary); margin-top: 1rem;">
                        <span>üí° Rating is optional - you can skip and just save the version</span>
                    </div>
                    <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem; justify-content: flex-end;">
                        <button class="control-btn" onclick="closeRatingModal()" style="padding: 0.5rem 1.5rem;">Cancel</button>
                        <button class="control-btn" onclick="updateChainRating()" style="padding: 0.5rem 1.5rem;">Update Rating</button>
                        <button class="control-btn primary" onclick="addChainToCompare()" style="padding: 0.5rem 1.5rem;">Save Version</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chain Container -->
    <div id="chain-container" class="chain-container">
        <!-- Will be populated dynamically -->
    </div>
{% endblock %}

{% block scripts %}
    <script src="/static/js/chain.js"></script>
    <script>
        // Load chain data on page load
        window.addEventListener('DOMContentLoaded', async () => {
            const traceId = window.location.pathname.split('/').pop();
            if (traceId) {
                await loadChain(traceId);
            }
            await loadModels();
        });
    </script>
{% endblock %}

