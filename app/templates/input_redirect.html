{% extends "base.html" %}

{% block title %}Loading - Shram.ai{% endblock %}

{% block content %}
    <div style="display: flex; align-items: center; justify-content: center; min-height: 60vh; flex-direction: column; gap: 2rem;">
        <div style="text-align: center;">
            <div class="loading-spinner" style="width: 60px; height: 60px; margin: 0 auto 1.5rem;">
                <div style="width: 100%; height: 100%; border: 4px solid var(--border-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
            </div>
            <h2 style="color: var(--text-primary); margin-bottom: 0.5rem;">Processing Input</h2>
            <p style="color: var(--text-secondary); font-size: 1.1rem;">Loading your data...</p>
            <p id="input-id-display" style="color: var(--text-secondary); font-size: 0.9rem; font-family: monospace; margin-top: 1rem;">{{ input_id }}</p>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script>
        const inputId = "{{ input_id }}";
        
        async function processAndRedirect() {
            try {
                // Call the process input API
                const response = await fetch('/api/process-input', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ input: inputId })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to process input');
                }
                
                const data = await response.json();
                console.log('Received data:', data);
                
                // Redirect based on data type
                if (data.is_chain && data.trace_id) {
                    window.location.href = `/prompt-chain/${data.trace_id}`;
                } else if (data.metadata && data.metadata.event_id) {
                    window.location.href = `/generation/${data.metadata.event_id}`;
                } else {
                    showError('Unable to determine data type');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                }
            } catch (error) {
                console.error('Error processing input:', error);
                showError(error.message || 'Failed to load data');
                setTimeout(() => {
                    window.location.href = '/';
                }, 3000);
            }
        }
        
        function showError(message) {
            const container = document.querySelector('[style*="min-height: 60vh"]');
            if (container) {
                container.innerHTML = `
                    <div style="text-align: center; max-width: 500px;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
                        <h2 style="color: var(--text-primary); margin-bottom: 1rem;">Error</h2>
                        <p style="color: #dc2626; font-size: 1.1rem; margin-bottom: 1rem;">${escapeHtml(message)}</p>
                        <p style="color: var(--text-secondary);">Redirecting to home page...</p>
                    </div>
                `;
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Start processing when page loads
        window.addEventListener('DOMContentLoaded', processAndRedirect);
    </script>
{% endblock %}

